<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>van den Blog</title>
  <meta name="description" content="Python, Data, and more">

  
  
  <link rel="stylesheet" href="/assets/style.css">

  <link rel="canonical" href="/notebooks/nyccitibikeclean.html">
  <link rel="alternate" type="application/rss+xml" title="van den Blog" href="/feed.xml">

  <script async defer src="https://buttons.github.io/buttons.js"></script>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-105892364-1', 'auto');
  ga('send', 'pageview');

</script>
</head>


  <body>

    <header class="border-bottom-thick px-2 clearfix">
  <div class="left sm-width-full py-1 mt-1 mt-lg-0">
    <a class="align-middle link-primary text-accent" href="/">
      van den Blog
    </a>
  </div>
  <div class="right sm-width-full">
    <ul class="list-reset mt-lg-1 mb-2 mb-lg-1">
      
        
        <li class="inline-block">
          <a class="align-middle link-primary mr-2 mr-lg-0 ml-lg-2" href="/about/">
            About
          </a>
        </li>
        
      
        
      
        
      
        
        <li class="inline-block">
          <a class="align-middle link-primary mr-2 mr-lg-0 ml-lg-2" href="/resume.html">
            Resume
          </a>
        </li>
        
      
        
      
    </ul>
  </div>
</header>


    <div>
      <article class="container mx-auto px-2 mt2 mb4">
  <header>
    <h1 class="h0 py-4 mt-3">1 Day of New York Citi Bikes</h1>
  </header>
  <div class="col-4 sm-width-full border-top-thin">
  </div>
  <div class="prose mb-4 py-4">
    <h1 id="1-day-of-new-york-citi-bikes">1 Day of New York Citi Bikes</h1>

<p>The code used to create the plot</p>

<h4 id="imports">Imports</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>  
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shapefile</span>
<span class="kn">import</span> <span class="nn">matplotlib.cbook</span> <span class="k">as</span> <span class="n">cbook</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">matplotlib.path</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="kn">import</span> <span class="n">Basemap</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KernelDensity</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="n">dates</span>
<span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="kn">import</span> <span class="n">imread</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</code></pre></div></div>

<h3 id="get-the-data">Get the data</h3>

<p>First we need to get the data, the data used is loaded from the Citi Bike API every minute and written to a CSV file. This code is not very robust but it gets the job done.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">station_link</span> <span class="o">=</span> <span class="s">'https://gbfs.citibikenyc.com/gbfs/en/station_status.json'</span>
<span class="n">station_info_link</span> <span class="o">=</span> <span class="s">'https://gbfs.citibikenyc.com/gbfs/en/station_information.json'</span>
<span class="n">station_csv</span> <span class="o">=</span> <span class="s">'station_status.csv'</span>


<span class="k">def</span> <span class="nf">get_station_df</span><span class="p">(</span><span class="n">station_info_df</span><span class="p">,</span> <span class="n">station_status_link</span><span class="p">):</span>
    
    <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">station_status_link</span><span class="p">)</span> <span class="k">as</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="n">station_status_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'data'</span><span class="p">][</span><span class="s">'stations'</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'station_id'</span><span class="p">)</span>
    
    <span class="n">station_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">station_status_df</span><span class="p">,</span> 
                      <span class="n">station_info_df</span><span class="p">,</span> 
                      <span class="n">left_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                      <span class="n">right_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">station_df</span> <span class="o">=</span> <span class="n">station_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ts</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">station_df</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">station_df</span>


<span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">station_info_link</span><span class="p">)</span> <span class="k">as</span> <span class="n">url</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">station_info_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'data'</span><span class="p">][</span><span class="s">'stations'</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'station_id'</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">station_df</span> <span class="o">=</span> <span class="n">get_station_df</span><span class="p">(</span><span class="n">station_info_df</span><span class="p">,</span> <span class="n">station_link</span><span class="p">)</span>
    <span class="n">station_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">station_csv</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'a'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="functions-to-create-the-plot">Functions to create the plot</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># The KDE Plot requires a long list of x, y coordinates. This function takes a dataframe with x, y coordinates </span>
<span class="c"># and a number of available bikes, and creates a much longer dataframe with one row for each available bike</span>

<span class="k">def</span> <span class="nf">create_expanded_df</span><span class="p">(</span><span class="n">all_status_df</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
    <span class="n">station_status_df</span> <span class="o">=</span> <span class="n">all_status_df</span><span class="p">[</span><span class="n">all_status_df</span><span class="o">.</span><span class="n">ts</span> <span class="o">==</span> <span class="n">timestamp</span><span class="p">]</span>
    <span class="n">expanded_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">station_status_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">num_bikes_available</span> <span class="o">=</span> <span class="n">station_status_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sid</span><span class="p">,</span> <span class="p">[</span><span class="s">'num_bikes_available'</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">num_bikes_available</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">expanded_sub_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">station_status_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sid</span><span class="p">,</span> 
                                                                 <span class="p">[</span><span class="s">'lat'</span><span class="p">,</span> <span class="s">'lon'</span><span class="p">,</span> <span class="s">'num_bikes_available'</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="p">]</span> 
                                    <span class="o">*</span> <span class="n">num_bikes_available</span><span class="p">)</span>
            <span class="n">expanded_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">expanded_df</span><span class="p">,</span> <span class="n">expanded_sub_df</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">expanded_df</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># This is the main function to create a plot.The function loads in a background image, plots the kde plot</span>
<span class="c"># over it, and plots a scatter plot over that again. </span>

<span class="k">def</span> <span class="nf">create_citi_bike_graph</span><span class="p">(</span><span class="n">expanded_df</span><span class="p">,</span> <span class="n">station_info_df</span><span class="p">,</span> <span class="n">non_expanded_df</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">all_status_df</span><span class="p">):</span>

    <span class="n">title</span> <span class="o">=</span> <span class="s">'New York Citi Bike - Bike Availability'</span> 
    <span class="n">ts_rounded</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="nb">round</span><span class="p">(</span><span class="s">'min'</span><span class="p">))</span>
    <span class="n">descripton</span> <span class="o">=</span> <span class="s">'Kernel Density Estimation of New York Citi Bike Availability during one day </span><span class="se">\n</span><span class="s">'</span> \
                  <span class="o">+</span> <span class="s">'Author: Chris van den Berg </span><span class="se">\n</span><span class="s">'</span> \
                  <span class="o">+</span> <span class="s">'Data: openstreetmap.org, citibikenyc.com'</span>
    <span class="n">imgfile</span> <span class="o">=</span> <span class="s">'./img/{}.png'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">'NYCB - </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">ts_rounded</span><span class="p">)</span>
    <span class="n">fontcolor</span><span class="o">=</span><span class="s">'#666666'</span>
    <span class="n">datafile</span> <span class="o">=</span> <span class="s">'./img/mapofnewyork.png'</span>
    
    <span class="c"># Read the image and add it to an Axis object. </span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">y</span><span class="o">=.</span><span class="mi">94</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">fontcolor</span><span class="p">)</span>
    
    <span class="c"># Set the axis to conform with the area in which citi bike stations are available. </span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">station_info_df</span><span class="p">[</span><span class="s">'lon'</span><span class="p">]</span><span class="o">.</span><span class="nb">min</span><span class="p">()</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">station_info_df</span><span class="p">[</span><span class="s">'lon'</span><span class="p">]</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">station_info_df</span><span class="p">[</span><span class="s">'lat'</span><span class="p">]</span><span class="o">.</span><span class="nb">min</span><span class="p">()</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">station_info_df</span><span class="p">[</span><span class="s">'lat'</span><span class="p">]</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span> 

    <span class="c"># Plot the KDE plot </span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">expanded_df</span><span class="p">[[</span><span class="s">'lon'</span><span class="p">,</span> <span class="s">'lat'</span><span class="p">]],</span> <span class="n">bw</span><span class="o">=</span><span class="mf">0.003</span><span class="p">,</span> <span class="n">shade</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">gridsize</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
                <span class="n">n_levels</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'Purples'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">shade_lowest</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># The standard KDE plot doesn't have transparent backgrounds. The following code adds a level</span>
    <span class="c"># of transparency to each level in the plot. </span>
    <span class="n">num_collections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="p">)</span>
    <span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="o">/</span><span class="n">num_collections</span><span class="p">)</span>
    <span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
        <span class="n">col</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">alphas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span>
        
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c"># Don't plot anything outside the boundaries of the image</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
    <span class="c"># min lon, max lon, min lat, max lat</span>

    
    <span class="c"># Add the scatterplot</span>
    <span class="n">non_expanded_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">non_expanded_df</span><span class="o">.</span>
                       <span class="n">assign</span><span class="p">(</span><span class="n">perc_bikes_available</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                           <span class="p">(</span><span class="n">non_expanded_df</span><span class="o">.</span><span class="n">num_bikes_available</span> <span class="o">/</span> <span class="n">non_expanded_df</span><span class="o">.</span><span class="n">capacity</span><span class="p">)</span>
                                                              <span class="o">*</span><span class="mi">100</span><span class="p">))</span><span class="o">.</span>
                       <span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                      <span class="p">)</span>

    <span class="n">latlon</span> <span class="o">=</span> <span class="n">non_expanded_df</span><span class="p">[[</span><span class="s">'lat'</span><span class="p">,</span> <span class="s">'lon'</span><span class="p">,</span> <span class="s">'perc_bikes_available'</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">sax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">latlon</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">latlon</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">latlon</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">"RdBu_r"</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">101</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>

    <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">])</span>  <span class="c"># left, bottom, width, height</span>
    <span class="n">cax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s">'vertical'</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">'</span><span class="si">% </span><span class="s">of spots used'</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">descripton</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">50</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">xycoords</span><span class="o">=</span><span class="s">'axes fraction'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">fontcolor</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">ts_rounded</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">37</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">xycoords</span><span class="o">=</span><span class="s">'axes fraction'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">fontcolor</span><span class="p">)</span>
    
    <span class="c"># Add the # avaiable bikes plot</span>
    <span class="n">naax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
    
    <span class="n">status_df_till_ts</span> <span class="o">=</span> <span class="n">all_status_df</span><span class="p">[</span><span class="n">all_status_df</span><span class="o">.</span><span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">ts</span><span class="p">]</span>
    <span class="n">status_df_till_ts</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'ts'</span><span class="p">)[</span><span class="s">'num_bikes_available'</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">naax</span><span class="p">)</span>
    
    <span class="n">naax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">dates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">H:</span><span class="si">%</span><span class="s">M'</span><span class="p">))</span>
    <span class="n">naax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">naax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">naax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">all_status_df</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="nb">min</span><span class="p">(),</span> <span class="n">all_status_df</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="nb">max</span><span class="p">())</span>
    <span class="n">naax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">all_status_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'ts'</span><span class="p">)[</span><span class="s">'num_bikes_available'</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span><span class="o">.</span><span class="nb">min</span><span class="p">(),</span>
                 <span class="n">all_status_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'ts'</span><span class="p">)[</span><span class="s">'num_bikes_available'</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span><span class="o">.</span><span class="nb">max</span><span class="p">())</span>
    <span class="n">naax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">'# Of Bikes Available'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    
    
    <span class="c"># Save the image</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">imgfile</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">'tight'</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c">#     plt.show()</span>
 
</code></pre></div></div>

<h3 id="the-code-to-create-the-different-frames">The code to create the different frames</h3>

<p>First we need to create a map of new york. I’ve used the Basemap libary for this, with data from openstreet maps. There are Citi bikes in the state of New York and in the state of New Jersey,  so we need to load the OSM files for this. I’ve used the shapefiles that can be found here: https://download.geofabrik.de/north-america.html. Running this code is slow, thats why I save the image only once and reload the image for every frame.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Load data created before. I ran in some formatting and memory issues, so didn't load everything</span>

<span class="n">station_csv</span> <span class="o">=</span> <span class="s">'station_status_2.csv'</span>
<span class="n">station_info_link</span> <span class="o">=</span> <span class="s">'https://gbfs.citibikenyc.com/gbfs/en/station_information.json'</span>

<span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">station_info_link</span><span class="p">)</span> <span class="k">as</span> <span class="n">url</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">station_info_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'data'</span><span class="p">][</span><span class="s">'stations'</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'station_id'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'nr invalid lines </span><span class="si">%</span><span class="s">d'</span> <span class="o">%</span> <span class="n">station_info_df</span><span class="p">[(</span><span class="n">station_info_df</span><span class="o">.</span><span class="n">lat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">station_info_df</span><span class="o">.</span><span class="n">lon</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span>
         <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c"># remove invalid lines</span>
    <span class="n">station_info_df</span> <span class="o">=</span> <span class="n">station_info_df</span><span class="p">[(</span><span class="n">station_info_df</span><span class="o">.</span><span class="n">lat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">station_info_df</span><span class="o">.</span><span class="n">lon</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)]</span>

<span class="n">all_status_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">station_csv</span><span class="p">,</span> <span class="n">error_bad_lines</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>  <span class="n">nrows</span><span class="o">=</span><span class="mi">2500000</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="s">"ISO-8859-1"</span><span class="p">)</span>
<span class="n">all_status_df</span><span class="p">[</span><span class="s">'ts'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">all_status_df</span><span class="o">.</span><span class="n">ts</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">imgfile</span> <span class="o">=</span> <span class="s">'./img/mapofnewyork.png'</span>
<span class="n">shpfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">'osm_roads_free_1'</span><span class="p">)</span> <span class="c"># State of NY</span>
<span class="n">fontcolor</span><span class="o">=</span><span class="s">'#666666'</span>
<span class="n">jerseyshpfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">'./newjersey/osm_roads_free_1'</span><span class="p">)</span> <span class="c"># State of NJ</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">axisbg</span><span class="o">=</span><span class="s">'w'</span><span class="p">)</span>

<span class="n">sf</span> <span class="o">=</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">shpfile</span><span class="p">)</span>
<span class="n">njsf</span> <span class="o">=</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">jerseyshpfile</span><span class="p">)</span>

<span class="n">x0</span> <span class="o">=</span> <span class="n">station_info_df</span><span class="p">[</span><span class="s">'lon'</span><span class="p">]</span><span class="o">.</span><span class="nb">min</span><span class="p">()</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">station_info_df</span><span class="p">[</span><span class="s">'lon'</span><span class="p">]</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span>
<span class="n">y0</span> <span class="o">=</span> <span class="n">station_info_df</span><span class="p">[</span><span class="s">'lat'</span><span class="p">]</span><span class="o">.</span><span class="nb">min</span><span class="p">()</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">station_info_df</span><span class="p">[</span><span class="s">'lat'</span><span class="p">]</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span>

<span class="n">latlon</span> <span class="o">=</span> <span class="n">expanded_df</span><span class="p">[[</span><span class="s">'lat'</span><span class="p">,</span> <span class="s">'lon'</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">y0</span> <span class="o">+</span> <span class="n">y1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">llcrnrlon</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> 
            <span class="n">llcrnrlat</span><span class="o">=</span><span class="n">y0</span><span class="p">,</span> <span class="n">urcrnrlon</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">urcrnrlat</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span> <span class="n">lat_0</span><span class="o">=</span><span class="n">cx</span><span class="p">,</span> <span class="n">lon_0</span><span class="o">=</span><span class="n">cy</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s">'c'</span><span class="p">,</span> 
            <span class="n">projection</span><span class="o">=</span><span class="s">'cyl'</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>

<span class="c"># Avoid border around map.</span>
<span class="n">m</span><span class="o">.</span><span class="n">drawmapboundary</span><span class="p">(</span><span class="n">fill_color</span><span class="o">=</span><span class="s">'#ffffff'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">0</span><span class="p">)</span>


<span class="n">m</span><span class="o">.</span><span class="n">readshapefile</span><span class="p">(</span><span class="n">shpfile</span><span class="p">,</span> <span class="s">'metro'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">15</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">readshapefile</span><span class="p">(</span><span class="n">jerseyshpfile</span><span class="p">,</span> <span class="s">'metro'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">imgfile</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">'tight'</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="load-the-csv-file">Load the CSV file</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#filter data for 1 day, and set correct datatypes</span>

<span class="n">all_status_df</span> <span class="o">=</span> <span class="n">all_status_df</span><span class="p">[(</span><span class="n">all_status_df</span><span class="o">.</span><span class="n">ts</span> <span class="o">&gt;=</span> <span class="s">'2017-08-04 00:00:01'</span><span class="p">)</span> 
                             <span class="o">&amp;</span> <span class="p">(</span><span class="n">all_status_df</span><span class="o">.</span><span class="n">ts</span> <span class="o">&lt;=</span> <span class="s">'2017-08-04 23:59:59'</span><span class="p">)</span>
                             <span class="p">]</span>
<span class="n">all_status_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_status_df</span><span class="p">[</span><span class="s">'station_id'</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="s">'station_id'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">999</span>

<span class="n">all_status_df</span><span class="p">[</span><span class="s">'station_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_status_df</span><span class="p">[</span><span class="s">'station_id'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">all_status_df</span><span class="p">[</span><span class="s">'num_bikes_available'</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_status_df</span><span class="p">[</span><span class="s">'num_bikes_available'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

<span class="n">all_status_df</span> <span class="o">=</span> <span class="n">all_status_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'station_id'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="create-the-plot">Create the plot</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Create one plot for every timestamp. As there is one timestamp per minute, this creates a plot for every</span>
<span class="c"># minute of the day</span>

<span class="n">unique_ts</span> <span class="o">=</span> <span class="n">all_status_df</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="n">unique_ts</span> <span class="o">=</span> <span class="n">unique_ts</span><span class="p">[</span><span class="n">unique_ts</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s">'2017-08-04 13:06:00'</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">current_ts</span> <span class="ow">in</span> <span class="n">unique_ts</span><span class="p">:</span>
    <span class="n">expanded_df</span> <span class="o">=</span> <span class="n">create_expanded_df</span><span class="p">(</span><span class="n">all_status_df</span><span class="p">,</span> <span class="n">current_ts</span><span class="p">)</span>
    <span class="n">non_expanded_df</span> <span class="o">=</span> <span class="n">all_status_df</span><span class="p">[</span><span class="n">all_status_df</span><span class="o">.</span><span class="n">ts</span> <span class="o">==</span> <span class="n">current_ts</span><span class="p">]</span>
    <span class="n">create_citi_bike_graph</span><span class="p">(</span><span class="n">expanded_df</span><span class="p">,</span> <span class="n">station_info_df</span><span class="p">,</span> <span class="n">non_expanded_df</span><span class="p">,</span> <span class="n">current_ts</span><span class="p">,</span> <span class="n">all_status_df</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">'all'</span><span class="p">)</span>
</code></pre></div></div>

  </div>
</article>

    </div>

    <div class="border-top-thin clearfix mt-2 mt-lg-4">
  <div class="container mx-auto px-2">
    <p class="col-8 sm-width-full left py-2 mb-0">This project is maintained by <a class="text-accent" href="https://github.com/bergvca">bergvca</a></p>
    <ul class="list-reset right clearfix sm-width-full py-2 mb-2 mb-lg-0">
      <li class="inline-block mr-1">
        <a href="https://twitter.com/share" class="twitter-share-button" data-hashtags="van den Blog">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
      </li>
      <li class="inline-block">
        <a class="github-button" href="https://github.com/bergvca/" data-icon="octicon-star" data-count-href="bergvca//stargazers" data-count-api="/repos/bergvca/#stargazers_count" data-count-aria-label="# stargazers on GitHub" aria-label="Star bergvca/ on GitHub">Star</a>
      </li>
    </ul>
  </div>
</div>


  </body>

</html>
